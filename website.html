<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Green Dream — ONG de Sostenibilidad</title>
  <meta name="description" content="Green Dream — Promoviendo prácticas sostenibles y educación ambiental.">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#31c48d;--muted:#94a3b8;--glass:rgba(255,255,255,0.04)}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial;color:#e6eef6;background:linear-gradient(180deg,#071026 0%,#07162b 60%);-webkit-font-smoothing:antialiased}
    header{padding:48px 24px;display:flex;align-items:center;gap:24px;max-width:1200px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:16px}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#2ee6a3,#1fb5a4);display:flex;align-items:center;justify-content:center;color:#01312a;font-weight:700;font-size:22px}
    h1{margin:0;font-size:28px;line-height:1.05}
    p.lead{margin:6px 0 0;color:var(--muted)}

    main{max-width:1200px;margin:24px auto;padding:0 24px;display:grid;grid-template-columns:1fr 420px;gap:28px}
    .hero{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:28px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    .hero h2{font-size:22px;margin:0 0 8px}
    .features{display:flex;gap:12px;margin-top:18px}
    .feature{background:var(--glass);padding:12px;border-radius:10px;color:var(--muted);flex:1}

    .chat-card{background:linear-gradient(180deg,#081826,#02111a);padding:18px;border-radius:14px;display:flex;flex-direction:column;height:640px}
    .chat-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .status{font-size:13px;color:var(--muted)}
    .messages{flex:1;overflow:auto;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:8px}
    .msg{max-width:82%;margin:8px 0;padding:10px 12px;border-radius:12px;line-height:1.35}
    .user{background:linear-gradient(90deg,#0f1724,#0b1830);color:#dbeafe;margin-left:auto;border-bottom-right-radius:4px}
    .bot{background:linear-gradient(90deg,#022b20,#043d2f);color:#e6fff5;border-bottom-left-radius:4px}
    .chat-controls{display:flex;gap:8px;margin-top:12px}
    textarea{resize:none;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;flex:1;height:54px}
    button{background:linear-gradient(90deg,var(--accent),#12a287);border:0;padding:10px 14px;border-radius:10px;color:#05251f;font-weight:600;cursor:pointer}
    button.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .samples{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .sample{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer;font-size:13px}

    footer{max-width:1200px;margin:30px auto 60px;padding:0 24px;color:var(--muted);font-size:14px}
    @media (max-width:980px){main{grid-template-columns:1fr} .chat-card{height:520px}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">GD</div>
      <div>
        <h1>Green Dream</h1>
        <p class="lead">ONG de sostenibilidad — Educación ambiental y proyectos comunitarios</p>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <h2>Impulsamos soluciones sostenibles y empresas verdes</h2>
      <p class="lead">Trabajamos con comunidades y empresas para reducir huella ecológica, impulsar economía circular y formar agentes de cambio.</p>

      <div class="features" style="margin-top:18px">
        <div class="feature">
          <strong>Educación</strong>
          <div class="muted">Cursos y talleres sobre prácticas sostenibles.</div>
        </div>
        <div class="feature">
          <strong>Proyectos</strong>
          <div class="muted">Iniciativas locales de reciclaje y conservación.</div>
        </div>
        <div class="feature">
          <strong>Asesoría</strong>
          <div class="muted">Consultoría para PYMEs verdes.</div>
        </div>
      </div>

      <h3 style="margin-top:20px">Prueba nuestro asistente</h3>
      <p class="lead">Usa el chat lateral para preguntar sobre cursos, proyectos o cómo colaborar.</p>
      <div style="margin-top:12px">
        <button id="healthCheckBtn" class="secondary">Comprobar estado API</button>
        <span id="healthResult" style="margin-left:12px;color:var(--muted)"></span>
      </div>
    </section>

    <aside>
      <div class="chat-card">
        <div class="chat-header">
          <div>
            <strong>WebChat — Green Dream</strong>
            <div class="status" id="apiUrlLabel">Conectando...</div>
          </div>
          <div style="text-align:right">
            <div class="status" id="healthSmall">—</div>
            <button id="clearBtn" class="secondary">Limpiar</button>
          </div>
        </div>

        <div class="messages" id="messages" aria-live="polite"></div>

        <div class="samples" id="samples">
          <div class="sample">¿Qué cursos recomiendan?</div>
          <div class="sample">¿Cómo colaborar con Green Dream?</div>
          <div class="sample">Dame ideas para reducir residuos.</div>
        </div>

        <div class="chat-controls">
          <textarea id="messageInput" placeholder="Escribe tu mensaje..."></textarea>
          <button id="sendBtn">Enviar</button>
        </div>
      </div>
    </aside>
  </main>

  <footer>
    <div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
      <div>© <strong>Green Dream</strong> — Promoviendo un futuro sostenible.</div>
      <div style="color:var(--muted)">API disponible en <code>/api/*</code></div>
    </div>
  </footer>

  <script>
    const CANDIDATES = ['http://host.docker.internal:5001', 'http://localhost:5001'];
    let BASE_URL = CANDIDATES[CANDIDATES.length-1];

    async function detectBaseUrl(timeout=800){
      for(const url of CANDIDATES){
        try{
          const r = await fetch(url + '/api/health', {method:'GET', cache:'no-cache'});
          if(r.ok) { BASE_URL = url; return url; }
        }catch(e){ /* continue */ }
      }
      return BASE_URL;
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function renderMarkdown(s){
      if(!s) return '';
      // Escape HTML first
      let t = escapeHtml(s);
      // Convert markdown links [text](url)
      t = t.replace(/\[([^\]]+)\]\((https?:\/\/[^)\s]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
      // Convert bold **text** to <strong>
      t = t.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      // Preserve line breaks
      t = t.replace(/\r?\n/g, '<br>');
      return t;
    }

    function appendMessage(text, cls){
      const node = document.createElement('div');
      node.className = 'msg '+cls;
      // Render markdown-like content and preserve line breaks
      node.innerHTML = renderMarkdown(text);
      const wrap = document.getElementById('messages');
      wrap.appendChild(node);
      wrap.scrollTop = wrap.scrollHeight;
    }

    function setHealthLabel(text){
      document.getElementById('healthSmall').textContent = text;
    }

    document.getElementById('healthCheckBtn').addEventListener('click', async ()=>{
      document.getElementById('healthResult').textContent = 'Comprobando...';
      try{
        const r = await fetch(BASE_URL + '/api/health');
        const j = await r.json();
        document.getElementById('healthResult').textContent = j.status + (j.assistant_initialized? ' (assistant OK)': '');
      }catch(e){
        document.getElementById('healthResult').textContent = 'No disponible';
      }
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      document.getElementById('messages').innerHTML = '';
    });

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keydown', (e)=>{if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); sendMessage();}});

    document.querySelectorAll('.sample').forEach(el=>el.addEventListener('click', ()=>{document.getElementById('messageInput').value = el.textContent; sendMessage();}));

    async function sendMessage(){
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if(!text) return;
      appendMessage(text, 'user');
      input.value = '';
      appendMessage('Pensando...', 'bot');
      const messages = document.getElementById('messages');
      const lastBot = messages.querySelector('.bot:last-child');
      try{
        const res = await fetch(BASE_URL + '/api/chat', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: text})
        });
        const json = await res.json();
        if(res.ok && json.response){
          if(lastBot) lastBot.innerHTML = renderMarkdown(json.response);
          setHealthLabel('online');
        } else {
          if(lastBot) lastBot.innerHTML = renderMarkdown('Error: ' + (json.error || res.statusText));
          setHealthLabel('error');
        }
      }catch(err){
        if(lastBot) lastBot.innerHTML = renderMarkdown('Error: imposible conectar con la API');
        setHealthLabel('offline');
      }
    }

    (async ()=>{
      const detected = await detectBaseUrl();
      document.getElementById('apiUrlLabel').textContent = detected + '/api';

      // Obtener saludo inicial (si existe) y mostrarlo una sola vez
      try{
        const welcome = await fetch(detected + '/api/welcome');
        if(welcome.status === 200){
          const j = await welcome.json();
          if(j && j.welcome){
            appendMessage(j.welcome, 'bot');
            setHealthLabel('online');
          }
        }
      }catch(e){ /* no crítico */ }

      try{
        const r = await fetch(detected + '/api/health');
        if(r.ok) setHealthLabel('online'); else setHealthLabel('error');
      }catch(e){ setHealthLabel('offline'); }
    })();
  </script>
</body>
</html>
